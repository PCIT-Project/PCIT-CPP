def std_exp = @import("std_exp/std_exp.pthr");


interface ConstIterable = {
	func createIterator = (this) #rt -> ConstIterator;
	func size = (this) #rt -> USize;
}


interface ConstIterator = {
	func next = (this mut) #rt -> Void;
	func get = (this) #rt -> $$*;
	func atEnd = (this) #rt -> Bool;
}


type Array = struct {
	def LENGTH: USize = 4;

	func new = (data: [Int:LENGTH] in) -> (output: This) {
		output._data = forward data;
		return...;
	}

	func [] = (this, index: USize) -> Int* {
		return this._data[index];
	}

	func [] = (this mut, index: USize) -> Int*mut {
		return this._data[index];
	}

	func size = (this) -> USize {
		return LENGTH;
	}



	func createConstIterator = (this) #rt -> ConstArrIter {
		return new ConstArrIter(&this);
	}


	impl ConstIterable {
		createIterator = createConstIterator,
		size           = size,
	}



	var _data: [Int:LENGTH];


	///////////////////////////////////
	// iters

	type ConstArrIter = struct {
		func new = (arr: Array*) -> (output: ConstArrIter) {
			output.arr = copy arr;
			output.current = arr[0];
			output.last = arr[arr.size() - 1];
			return...;
		}

		func next = (this mut) -> Void {
			const new_address: USize = std_exp.bitCast<{USize}>(this.current) + @numBytes<{Int}>();
			this.current = @bitCast<{USize, Int*}>(new_address);
		}

		func get = (this) -> Int* { return copy this.current; }

		func atEnd = (this) -> Bool {
			return std_exp.bitCast<{USize}>(this.current) > std_exp.bitCast<{USize}>(this.last);
		}

		impl ConstIterator{
			next  = next,
			get   = get,
			atEnd = atEnd,
		}

		var arr: Array*;
		var current: Int*;
		var last: Int*;
	}
}





func sum_arr = (iterable: ConstIterable) #rt -> Int {
	func sum_arr_impl = (iter: ConstIterator in) -> (count: Int) {
		count = 0;

		while(iter.atEnd() == false){
			defer{ iter.next(); }
			count += iter.get().*;
		}

		return...;
	}

	return sum_arr_impl(iterable.createIterator());
}





func entry = () #entry -> UI8 {
	var array = new Array(new [Int:Array.LENGTH][1, 2, 3, 4]);

	return sum_arr(array) as UI8;
}






// interface Poly = #polymorphic {
// 	func get_num = (this) -> UI8;
// 	func increase_num = (this mut) -> Void;
// }

// type Thing = struct {
// 	func get_num = (this) -> UI8 {
// 		return copy this.num;
// 	}

// 	func increase_num = (this mut) -> Void {
// 		this.num = 14;
// 	}

// 	impl Poly{
// 		get_num      = get_num,
// 		increase_num = increase_num,
// 	}

// 	var num: UI8 = 12;
// }


// func get_poly_num = (poly: Poly^mut) -> UI8 {
// 	return poly.get_num();
// }


// func entry = () #entry -> UI8 {
// 	var foo = new Thing();
// 	var bar = new Thing();

// 	var poly: Poly^mut = foo as Poly^mut;
// 	poly.increase_num();

// 	poly = bar as Poly^mut;
// 	return get_poly_num(poly);
// }
